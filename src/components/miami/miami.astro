---
import Slider from "./Slider.astro";
---

<canvas data-animation-canvas class="h-dvh w-dvw"></canvas>

<Slider
  min={0}
  max={5}
  step={0.01}
  value={1}
  id="progress-bar"
  className="fixed z-10 bottom-2 left-2 right-2 m-auto max-w-[420px] p-3 w-full h-2"
/>

<script>
  import RuntimeLoader from "@lib/miami/rive-runtime-loader";
  import { type RiveCanvas as RiveCanvasType } from "@rive-app/canvas-advanced";

  const isDev = import.meta.env.MODE === "development";

  const logger = {
    log: (...args: unknown[]) => {
      if (isDev) {
        console.log(...args);
      }
    },
  };

  let speed = 1;

  document.getElementById("progress-bar")?.addEventListener("input", (e) => {
    speed = parseFloat((e.target as HTMLInputElement).value);
  });

  async function init() {
    const canvas = document.querySelector(
      "[data-animation-canvas]"
    ) as HTMLCanvasElement | null;

    if (!canvas) {
      throw new Error("Canvas not found");
    }

    function computeSize() {
      canvas!.width = window.innerWidth;
      canvas!.height = window.innerHeight;
    }

    window.onresize = computeSize;
    computeSize();

    const rive = (await RuntimeLoader.awaitInstance()) as RiveCanvasType;
    let fileBytes = new Uint8Array(
      await (await fetch(new Request("/miami/miami_v3/r.riv"))).arrayBuffer()
    );
    const file = (await rive.load(new Uint8Array(fileBytes))) as any;

    const renderer = rive.makeRenderer(canvas);

    let lastTime: number;
    const artboard = file.artboardByName(file.defaultArtboard().name);

    // const stateMachine = new rive.StateMachineInstance(
    //   artboard.animationByIndex(0),
    //   artboard
    // );
    // const idleAnimation = new rive.LinearAnimationInstance(
    //   artboard.animationByIndex(0),
    //   artboard
    // );

    function draw(time: number) {
      if (!lastTime) {
        lastTime = time;
      }
      const elapsedSeconds = (time - lastTime) / 1000;
      lastTime = time;

      renderer.clear();
      artboard.advance(elapsedSeconds * speed);

      renderer.save();

      renderer.align(
        rive.Fit.contain,
        rive.Alignment.center,
        {
          minX: 0,
          minY: 0,
          maxX: canvas!.width,
          maxY: canvas!.height,
        },
        artboard.bounds
      );
      artboard.draw(renderer);
      renderer.restore();

      rive.requestAnimationFrame(draw);
    }

    rive.requestAnimationFrame(draw);

    return rive;
  }

  const animation = await init();
</script>
